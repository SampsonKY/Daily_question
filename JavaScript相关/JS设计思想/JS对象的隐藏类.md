# 隐藏类



## 静态语言与动态语言

![静态语言VS动态语言](https://static001.geekbang.org/resource/image/20/d7/205a2fa05c6aba57ade25f3a1df2bad7.jpg?ynotemdtimestamp=1612407166483)

- JavaScript是一门动态编程语言，JS在运行时，对象的属性是可以被修改的。所以当V8使用了一个对象时，它并不知道该对象中是否有某一属性，也不知道该属性相对于对象的偏移量是多少，也就是说V8并不知道该对象的具体形状。
- 当在JS中查询对象某一属性时，V8会按照具体规则一步一步来查询，这个过程非常的慢且耗时（具体看上一篇）。
- 而像C++这种静态语言，在声明一个对象之前需要定义该对象的结构，也称之为形状。我们可以使用这个形状来定义具体的对象。
- `C++`代码在执行前需要先被编译，编译的时候，每个对象的形状都是固定的。所以在`C++`中访问一个对象的属性时，自然就知道该属性相对于该对象的偏移值了。

## 隐藏类

**思想**

> 这种静态的特性被引入到了V8中。

- 目前采用的思想就是将JS中的对象静态化，也就是V8在运行JS过程中，会假设JS中的对象时静态的，具体来说：对象创建好后不会添加新的属性，也不会删除属性。
- 具体做法：V8会为每个对象创建一个隐藏类（map），对象的隐藏类中记录了该对象的一些基础的布局信息，包括：对象中所包含的所有的属性，每个属性相对于对象的偏移量。
- 有了隐藏类后，当V8访问某个对象的某个属性时，就会先去隐藏类中查找该属性相对于它的对象的偏移量，有了偏移量和属性类型，V8就可以直接去内存中取出对应的属性值。大大提升了查找对象的效率。

**多个对象共用一个隐藏类**

- 如果两个对象的形状是相同的（相同的属性名，相等的属性个数），V8就会为其复用一个隐藏类，这样：减少了隐藏类的创建次数，也间接加速了代码的执行速度；减少了隐藏类的存储空间。

**重新构建隐藏类** 给对象添加新的属性，删除属性，或改变某个属性的数据类型都会改变这个对象的形状，那么也就会触发V8为改变形状后的对象重建新的隐藏类

## 最佳实践

**总结**

- V8为每个对象分配一个隐藏类，在执行过程中：
  - 如果对象的形状没有改变，那么该对象就会一直使用该隐藏类
  - 如果对象形状发生改变，V8会重建一个新的隐藏类给该对象 **注意** 为了避免对象中的隐藏类没必要的重建，需要注意：
- 使用字面量初始化对象时，要保证属性的顺序是一致的。
- 尽量使用字面量一次性初始化完整对象属性。
- 尽量避免使用delete方法。